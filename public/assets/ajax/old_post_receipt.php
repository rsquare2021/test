<?php
//////////////////////////////////////////////////////////
// DB
//////////////////////////////////////////////////////////
//setlocale(LC_ALL, 'ja_JP.UTF-8');
try {
  $dsn = 'mysql:dbname=laravel_local;host=db;charset=utf8;';
  $user = 'phper';
  $password = 'secret';
  $PDO = new PDO($dsn, $user, $password);
  $PDO->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
  } catch (PDOException $e) {
  exit('接続できませんでした。' . $e->getMessage());
}


//////////////////////////////////////////////////////////
// 変数セット
//////////////////////////////////////////////////////////
/*
  str = レシートで読み取った文字
  tel = 電話番号
  no = レシートナンバー
  pay_date = レシートに記載された日付php
  point = 数量に対するポイント
  user_id = レシート送信者ID
  campaign_id = レシート送信したキャンペーンID
  val = 入力した給油量
  products = 商品名 & 給油量の組み合わせ
  isChange = 
  isNg = NGリストの文字が含まれる
  receipt_path = レシート画像パス
  fileName & temp_path & target_path & directory_path = 画像保存用
  start_time = レシート受け付け開始年月日
  end_time = レシート受け付け終了年月日
  term = 対象期間外の場合true
  isShopNg = 対象期間外の場合true
  double = 重複していた場合true
  re_point = レシートに記載されている給油量から計算したポイント
  re_oil = レシートに記載されている給油量
  productNg = 対象商品がない場合はtrue
  campaign_shop_tree = キャンペーン参加店舗ツリー
  company = レシートに記載されている会社名
  tel_blank = 電話番号ではない
*/
$str = filter_input(INPUT_POST,"str");
$tel = filter_input(INPUT_POST,"tel");
$no = filter_input(INPUT_POST,"no");
$no2 = filter_input(INPUT_POST,"no");
$pay_date = filter_input(INPUT_POST,"pay_date");
$time = filter_input(INPUT_POST,"time");
$point = filter_input(INPUT_POST,"point");
$user_id = filter_input(INPUT_POST,"user_id");
$campaign_id = filter_input(INPUT_POST,"campaign_id");
$val = filter_input(INPUT_POST,"val");
$products = filter_input(INPUT_POST,"products");
$isChange = filter_input(INPUT_POST,"isChange");
$isNg = filter_input(INPUT_POST,"isNg");
$isLightNg = filter_input(INPUT_POST,"isLightNg");
$receipt_path = "/receipt/".$campaign_id."/".$user_id."_".date("YmdHis").".jpg";
$fileName = $_FILES['image']['name'];
$tmp_path = $_FILES['image']['tmp_name'];//mb_convert_encoding($_FILES['file']['tmp_name'], "cp932", "utf8");
$directory_path = dirname(__FILE__)."/receipt/".$campaign_id."/";
$target_path = dirname(__FILE__).$receipt_path;
$start_time = filter_input(INPUT_POST,"start_time");
$end_time = filter_input(INPUT_POST,"end_time");
$term = filter_input(INPUT_POST,"term");
$re_point = filter_input(INPUT_POST,"re_point");
$re_oil = filter_input(INPUT_POST,"re_oil");
$productNg = filter_input(INPUT_POST,"productNg");
$campaign_shop_tree = filter_input(INPUT_POST,"campaign_shop_tree");
$com = filter_input(INPUT_POST,"com");
$isAccept = filter_input(INPUT_POST,"accept");
$tel_blank = filter_input(INPUT_POST,"telBlank");
$tel_company = '';
$isDouble = filter_input(INPUT_POST,"double");
//$str = mb_convert_encoding($str, "UTF-8", "auto");
//$tel = mb_convert_encoding($tel, "UTF-8", "auto");
//$pay_date = mb_convert_encoding($pay_date, "UTF-8", "auto");


//////////////////////////////////////////////////////////
// 登録処理中断
//////////////////////////////////////////////////////////
// 画像が取得できない
if(!is_uploaded_file($_FILES["image"]["tmp_name"])) {
  header('content-type: application/json; charset=utf-8');
  echo json_encode(array(
    "result" => false,
    "reason" => "受け付けできませんでした。<br>レシート撮影時の注意事項を確認の上、再度送信してください。"
  ));
  exit();
}

// レシートが重複している（no tel pay_date）
//$isAccept エラー後の再撮影は許可?
if($isAccept == 0){
  // if(!empty($no) && !empty($tel) && !empty($pay_date)) {
  //   $sql = "SELECT * FROM receipts WHERE mk_no = :no AND mk_tel = :tel AND mk_date = :pay_date AND mk_time = :time";
  //   $stmt = $PDO -> prepare($sql);
  //   $stmt->bindValue(':tel', $tel, PDO::PARAM_STR);
  //   $stmt->bindValue(':no', $no, PDO::PARAM_STR);
  //   $stmt->bindValue(':pay_date', $pay_date, PDO::PARAM_STR);
  //   $stmt->bindValue(':time', $time, PDO::PARAM_STR);
  //   $stmt->execute();
  //   if($stmt -> rowCount() > 0){
  //     header('content-type: application/json; charset=utf-8');
  //     echo json_encode(array(
  //       "result" => false,
  //       "double" => true,
  //       "reason" => "既に登録されているレシートです。"
  //     ));
  //     exit();
  //   }
  // }
  if(!empty($tel)) {
    $sql = "SELECT * FROM flat_shop_tree_elements WHERE root_id = 1 AND depth = 3 AND tel = :tel";
    $stmt = $PDO -> prepare($sql);
    $stmt->bindValue(':tel', $tel, PDO::PARAM_STR);
    $stmt->execute();
    $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
    foreach ($result as $row) {
      $tel_company = $row['name'];
    }
    $count = $stmt -> rowCount();
    if($stmt -> rowCount() == 0){
      header('content-type: application/json; charset=utf-8');
      echo json_encode(array(
        "result" => false,
        "isShopNg" => true,
        "reason" => "対象外の店舗の可能性があります。"
      ));
      exit();
    }
  } elseif(empty($tel) || $tel_blank == 1) {
    header('content-type: application/json; charset=utf-8');
    echo json_encode(array(
      "result" => false,
      "reason" => "店舗が読み取れません。"
    ));
    exit();
  }
}

// 再送信の重複確認
// $isDouble = 0;
// if($isAccept == 1){
//   if(!empty($no) && !empty($tel) && !empty($pay_date)) {
//     $sql = "SELECT * FROM receipts WHERE no = :no AND tel = :tel AND pay_date = :pay_date AND time = :time";
//     $stmt = $PDO -> prepare($sql);
//     $stmt->bindValue(':tel', $tel, PDO::PARAM_STR);
//     $stmt->bindValue(':no', $no, PDO::PARAM_STR);
//     $stmt->bindValue(':pay_date', $pay_date, PDO::PARAM_STR);
//     $stmt->bindValue(':time', $time, PDO::PARAM_STR);
//     $stmt->execute();
//     if($stmt -> rowCount() > 0){
//       $isDouble = 1;
//     }
//   }
// }

// 店舗特定
$isShopNg = 0;
$sql = "SELECT * FROM flat_shop_tree_elements WHERE root_id = 1 AND depth = 3 AND tel = :tel";
$stmt = $PDO -> prepare($sql);
$stmt->bindValue(':tel', $tel, PDO::PARAM_STR);
$stmt->execute();
$result = $stmt->fetchAll(PDO::FETCH_ASSOC);
foreach ($result as $row) {
  $tel_company = $row['name'];
}
$count = $stmt -> rowCount();
if($stmt -> rowCount() == 0){
  $isShopNg = 1;
}

//////////////////////////////////////////////////////////
// ステータス分岐
//////////////////////////////////////////////////////////
// 初期ステータス = 000000000
// ステータス初期セット
$status_product = "0"; //1_対象商品
$status_oil = "0"; //2_給油量
$status_input = "0"; //3_自己申告
$status_diff = "0"; //4_自己申告と実際の給油量の差
$status_term = "0"; //5_対象期間
$status_shop = "0"; //6_対象店舗
$status_double = "0"; //7_重複
$status_ngword = "0"; //8_NGワード
$status_count = "0"; //9_強制送信
$status_status = "0";
// 1_対象商品のレシートではない 100000000
// if($productNg == "1") {
//   $status_product = "1";
//   $status_status = "11";
// }
// 2_レシートに記載されている給油量が不明 010000000
// if($re_oil == '' || is_null($re_oil)) {
//   $status_oil = "2";
//   $status_status = "11";
// }
// 2_レシートに記載されている給油量から計算したポイントが0以下 020000000
// if($re_point <= '0') {
//   $status_oil = "1";
//   $status_status = "11";
// }
// 3_給油量をユーザーが変更 001000000
if((int)$isChange == 1){
  $status_input = "1";
  $status_status = "11";
}
// 4_レシートの給油量とユーザー入力の給油量に差がある 000100000
$floor_val = floor($val);
if($re_oil) {
  $floor_re_oil = floor($re_oil);
  $status_status = "11";
} else {
  $floor_re_oil = 0;
  $status_status = "11";
}
if($floor_val != $floor_re_oil) {
  $status_diff = "1";
  $status_status = "11";
}
// 5_レシート日時が不明 000010000
// if($pay_date == '' || is_null($pay_date)) {
//   $status_term = "2";
//   $status_status = "11";
//   // $status_term = "0";
// }
// 5_キャンペーン期間 000020000
// if((int)$term == 1) {
//   $status_term = "1";
//   $status_status = "11";
//   // $status_term = "0";
// }
// 7_重複 000000100
if($isDouble == 1) {
  $status_double = 1;
  $status_status = "11";
}
//  elseif($no == '') {
//   $status_double = 2;
//   $status_status = "11";
// }
// 9_撮り直し 000000001
if($isAccept) {
  $status_count = "1";
  $status_status = "11";
}
// 6_対象店舗 000001000
if($tel == '') {
  $status_shop = 2;
  $status_status = "31";
} elseif($isShopNg == 1) {
  $status_shop = 1;
  $status_status = "31";
}
// 8_NGリストの単語が見つかった 000000010
// if($isLightNg == 1) {
//   $status_ngword = "2";
//   $status_status = "11";
// }
if((int)$isNg == 1){
  $status_ngword = "1";
  $status_status = "34";
}

// 最終ステータス
$status = $status_product.$status_oil.$status_input.$status_diff.$status_term.$status_shop.$status_double.$status_ngword.$status_count;
if($status == '000000000') {
  $status_status = 0;
}

//////////////////////////////////////////////////////////
// レシート画像処理
//////////////////////////////////////////////////////////
if(file_exists($directory_path)){
}
else{
	if(mkdir($directory_path, 0777)){
		chmod($directory_path, 0777);
  }else{
  }
}
if(is_uploaded_file($tmp_path) ) {
	if(move_uploaded_file($tmp_path, $target_path)){
	}
  else{
    header('content-type: application/json; charset=utf-8');
    echo json_encode(array(
      "result" => false
    ));
    exit();
  }
}
else{
  header('content-type: application/json; charset=utf-8');
  echo json_encode(array(
    "result" => false
  ));
  exit();
}


//////////////////////////////////////////////////////////
// receiptsテーブル
//////////////////////////////////////////////////////////
$sql = "INSERT INTO receipts (
  campaign_id,
  user_id,
  point,
  products,
  tel,
  no,
  status,
  pay_date,
  time,
  receipt_path,
  mk_status,
  tel_company,
  company,
  receipt_value,
  receipt_str,
  receipt_memo,
  mk_no,
  mk_tel,
  mk_date,
  mk_time,
  created_at,
  updated_at) 
  VALUES (
  :campaign_id,
  :user_id,
  :point,
  :products,
  :tel,
  :no,
  :status_status,
  :pay_date,
  :time,
  :receipt_path,
  :status,
  :tel_company,
  :com,
  :val,
  :receipt_str,
  '',
  :no2,
  :tel,
  :pay_date,
  :time,
  CURRENT_TIMESTAMP,
  CURRENT_TIMESTAMP)";
$stmt = $PDO -> prepare($sql);
$stmt->bindValue(':campaign_id', $campaign_id, PDO::PARAM_INT);
$stmt->bindValue(':user_id', $user_id, PDO::PARAM_INT);
$stmt->bindValue(':point', $point, PDO::PARAM_INT);
$stmt->bindValue(':products', $products, PDO::PARAM_STR);
$stmt->bindValue(':tel', $tel, PDO::PARAM_STR);
$stmt->bindValue(':no', $no, PDO::PARAM_STR);
$stmt->bindValue(':no2', $no2, PDO::PARAM_STR);
$stmt->bindValue(':pay_date', $pay_date, PDO::PARAM_STR);
$stmt->bindValue(':time', $time, PDO::PARAM_STR);
$stmt->bindValue(':status_status', $status_status, PDO::PARAM_STR);
$stmt->bindValue(':receipt_path', $receipt_path, PDO::PARAM_STR);
$stmt->bindValue(':receipt_str', $str, PDO::PARAM_STR);
$stmt->bindValue(':status', $status, PDO::PARAM_STR);
$stmt->bindValue(':tel_company', $tel_company, PDO::PARAM_STR);
$stmt->bindValue(':com', $com, PDO::PARAM_STR);
$stmt->bindValue(':val', $val, PDO::PARAM_STR);
$stmt->execute();
//echo $campaign_id.",".$user_id.",".$tel.",".$pay_date.",".$receipt_path.",".$val.",".$str;


//////////////////////////////////////////////////////////
// users_pre_pointsテーブル
//////////////////////////////////////////////////////////
// 送信したレシートをチェック
$sql = "SELECT id,mk_status FROM receipts WHERE user_id = :user_id ORDER BY created_at DESC LIMIT 1";
$stmt = $PDO -> prepare($sql);
$stmt->bindValue(':user_id', $user_id, PDO::PARAM_INT);
$stmt->execute();
$po_id = null;
while($row = $stmt->fetch(PDO::FETCH_ASSOC)){
  if($row["mk_status"] == "0") {
    $po_id = $row["id"];
  }
}
// 送信したレシートが目検ステータス0だった場合
if($po_id) {
  $sql = "INSERT INTO users_pre_points (
    receipt_id,
    point,
    created_at,
    updated_at)
    VALUES(
    :point_id,
    :point,
    CURRENT_TIMESTAMP,
    CURRENT_TIMESTAMP)";
    
  $stmt = $PDO -> prepare($sql);
  $stmt->bindValue(':point_id', (int)$po_id, PDO::PARAM_INT);
  $stmt->bindValue(':point', (int)$point, PDO::PARAM_INT);
  $stmt->execute();
}


header('content-type: application/json; charset=utf-8');
echo json_encode(array(
  "result" => true,
));
?>
